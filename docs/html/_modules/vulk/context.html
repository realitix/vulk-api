<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>vulk.context &#8212; Vulk 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for vulk.context</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Module to create Window and Vulkan context</span>

<span class="sd">This module contains class to create the SDL2 window and the Vulkan</span>
<span class="sd">logical device and queues.</span>
<span class="sd">The context will be then passed to the Application to use it.</span>

<span class="sd">Vulk uses a specific way to interact with Vulkan that allow a good</span>
<span class="sd">abstraction. Instead of performing the final drawing operation</span>
<span class="sd">directly on the swapchain&#39;s images, Vulk performs all operations on</span>
<span class="sd">custom images and framebuffer and finally just copy the result in the</span>
<span class="sd">swapchain&#39;s image.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sdl2</span>
<span class="kn">import</span> <span class="nn">sdl2.ext</span>
<span class="kn">import</span> <span class="nn">vulkan</span> <span class="k">as</span> <span class="nn">vk</span>  <span class="c1"># pylint: disable=import-error</span>

<span class="kn">from</span> <span class="nn">vulk.exception</span> <span class="k">import</span> <span class="n">VulkError</span><span class="p">,</span> <span class="n">SDL2Error</span>
<span class="kn">from</span> <span class="nn">vulk</span> <span class="k">import</span> <span class="n">vulkanconstant</span> <span class="k">as</span> <span class="n">vc</span>
<span class="kn">from</span> <span class="nn">vulk</span> <span class="k">import</span> <span class="n">vulkanobject</span> <span class="k">as</span> <span class="n">vo</span>
<span class="kn">from</span> <span class="nn">vulk.eventconstant</span> <span class="k">import</span> <span class="n">to_vulk_event</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">ENGINE_NAME</span> <span class="o">=</span> <span class="s2">&quot;Vulk 3D Engine&quot;</span>


<div class="viewcode-block" id="VulkWindow"><a class="viewcode-back" href="../../vulk.html#vulk.context.VulkWindow">[docs]</a><span class="k">class</span> <span class="nc">VulkWindow</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="VulkWindow.open"><a class="viewcode-back" href="../../vulk.html#vulk.context.VulkWindow.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Open the SDL2 Window</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `configuration`: Configurations parameters from Application</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_InitSubSystem</span><span class="p">(</span><span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_INIT_VIDEO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t open window: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_GetError</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SDL2Error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">fullscreen</span> <span class="ow">and</span> \
           <span class="n">configuration</span><span class="o">.</span><span class="n">width</span> <span class="ow">and</span> <span class="n">configuration</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_WINDOW_FULLSCREEN</span>
        <span class="k">elif</span> <span class="n">configuration</span><span class="o">.</span><span class="n">fullscreen</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_WINDOW_FULLSCREEN_DESKTOP</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">configuration</span><span class="o">.</span><span class="n">decorated</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_WINDOW_BORDERLESS</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">resizable</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_WINDOW_RESIZABLE</span>
        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">highdpi</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_WINDOW_ALLOW_HIGHDPI</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_CreateWindow</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">configuration</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">configuration</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">configuration</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">configuration</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t open window: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_GetError</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SDL2Error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SDL2 window opened with configuration: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">configuration</span><span class="p">,))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SysWMinfo</span><span class="p">()</span>
        <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_VERSION</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
        <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_GetWindowWMInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">))</span></div>

<div class="viewcode-block" id="VulkWindow.close"><a class="viewcode-back" href="../../vulk.html#vulk.context.VulkWindow.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SDL2 window closed&quot;</span><span class="p">)</span>
        <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_DestroyWindow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">)</span>
        <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_Quit</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="VulkContext"><a class="viewcode-back" href="../../vulk.html#vulk.context.VulkContext">[docs]</a><span class="k">class</span> <span class="nc">VulkContext</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Vulkan debug enabled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Vulkan instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Extension functions in a dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Instance to the debug callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_callback</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Surface to the window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Physical device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physical_device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Properties of physical device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physical_device_properties</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Features of physical device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physical_device_features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Logical device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Graphic queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphic_queue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Presentation queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">present_queue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Indices of queue families</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_family_indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Swapchain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swapchain</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Swapchain images (vulkanobject.Image type)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swapchain_images</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Swapchain format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swapchain_format</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Width of the window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Height of the window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Final image which is copied into swapchain image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Image view of the final image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_image_view</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Semaphores used during presentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_semaphore_available</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_semaphore_copied</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Semaphores used for direct rendering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direct_semaphores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Command buffers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandbuffers</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_instance_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get extensions which depend on the window and configuration</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `window`: The `VulkWindow`</span>
<span class="sd">        - `configuration`: Configuration from App</span>

<span class="sd">        *Returns:*</span>

<span class="sd">        Extension list</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Get available extensions</span>
        <span class="n">available_extensions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">e</span><span class="o">.</span><span class="n">extensionName</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkEnumerateInstanceExtensionProperties</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Available instance extensions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">available_extensions</span><span class="p">)</span>

        <span class="c1"># Compute needed extensions</span>
        <span class="n">extension_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SYSWM_X11</span><span class="p">:</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_KHR_XLIB_SURFACE_EXTENSION_NAME</span><span class="p">,</span>
            <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SYSWM_WINDOWS</span><span class="p">:</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_KHR_WIN32_SURFACE_EXTENSION_NAME</span><span class="p">,</span>
            <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SYSWM_WAYLAND</span><span class="p">:</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_KHR_WAYLAND_SURFACE_EXTENSION_NAME</span><span class="p">,</span>
            <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SYSWM_MIR</span><span class="p">:</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_KHR_MIR_SURFACE_EXTENSION_NAME</span>
        <span class="p">}</span>
        <span class="n">sdl_subsystem</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">subsystem</span>

        <span class="k">if</span> <span class="n">sdl_subsystem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extension_mapping</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Vulkan not supported on this plateform: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sdl_subsystem</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">VulkError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Select extension</span>
        <span class="n">enabled_extensions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">enabled_extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_KHR_SURFACE_EXTENSION_NAME</span><span class="p">)</span>
        <span class="n">enabled_extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extension_mapping</span><span class="p">[</span><span class="n">sdl_subsystem</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_EXT_DEBUG_REPORT_EXTENSION_NAME</span> <span class="ow">in</span> <span class="n">available_extensions</span><span class="p">:</span>
                <span class="n">enabled_extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">vk</span><span class="o">.</span><span class="n">VK_EXT_DEBUG_REPORT_EXTENSION_NAME</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Vulkan debug extension not present and debug&quot;</span>
                               <span class="s2">&quot;mode asked, disabling Vulkan debug mode&quot;</span><span class="p">)</span>

        <span class="c1"># Check extensions availability</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">e</span> <span class="ow">in</span> <span class="n">available_extensions</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">enabled_extensions</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Vulkan extensions are not all available&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">VulkError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">enabled_extensions</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_device_extensions</span><span class="p">(</span><span class="n">physical_device</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get device extensions</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `physical_device`: The VkPhysicalDevice to check</span>

<span class="sd">        *Returns:*</span>

<span class="sd">        Extension list</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Get available extensions</span>
        <span class="n">available_extensions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">e</span><span class="o">.</span><span class="n">extensionName</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkEnumerateDeviceExtensionProperties</span><span class="p">(</span>
                <span class="n">physical_device</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Available device extensions: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">available_extensions</span><span class="p">)</span>

        <span class="c1"># Select extensions</span>
        <span class="n">enabled_extensions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">enabled_extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_KHR_SWAPCHAIN_EXTENSION_NAME</span><span class="p">)</span>

        <span class="c1"># Check extensions availability</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">e</span> <span class="ow">in</span> <span class="n">available_extensions</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">enabled_extensions</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Vulkan extensions are not all available&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">VulkError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">enabled_extensions</span>

    <span class="k">def</span> <span class="nf">_get_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get all enabled layers</span>

<span class="sd">        Simple algorythm: return everything in debug mode else nothing</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - configuration: configuration from App</span>

<span class="sd">        *Returns:*</span>

<span class="sd">        List of all enabled layers</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">layerName</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span>
                  <span class="n">vk</span><span class="o">.</span><span class="n">vkEnumerateInstanceLayerProperties</span><span class="p">()]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Available layers: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>

        <span class="c1"># Standard validation is a meta layer containing the others</span>
        <span class="n">standard</span> <span class="o">=</span> <span class="s1">&#39;VK_LAYER_LUNARG_standard_validation&#39;</span>
        <span class="k">if</span> <span class="n">standard</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Selecting only </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">standard</span><span class="p">)</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">standard</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">layers</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_queue_families</span><span class="p">(</span><span class="n">physical_device</span><span class="p">,</span> <span class="n">surface</span><span class="p">,</span> <span class="n">pfn</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get graphic and present queue families</span>

<span class="sd">        Check for graphic and presentation queue families.</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `physical_device`: The `VkPhysicalDevice` to check for</span>
<span class="sd">        - `surface`: The `VkSurfaceKHR` to present</span>
<span class="sd">        - `pfn`: Function `vkGetPhysicalDeviceSurfaceSupportKHR` callable</span>

<span class="sd">        *Returns:*</span>

<span class="sd">        A tuple with graphic index and present index or None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">queue_families</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkGetPhysicalDeviceQueueFamilyProperties</span><span class="p">(</span><span class="n">physical_device</span><span class="p">)</span> <span class="c1"># noqa</span>

        <span class="n">graphic_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">present_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">queue_family</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">queue_families</span><span class="p">):</span>
            <span class="c1"># Queue family needs queues</span>
            <span class="k">if</span> <span class="n">queue_family</span><span class="o">.</span><span class="n">queueCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Check that queue family support present queue</span>
            <span class="n">present_available</span> <span class="o">=</span> <span class="n">pfn</span><span class="p">(</span><span class="n">physical_device</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">surface</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">queue_family</span><span class="o">.</span><span class="n">queueFlags</span> <span class="o">&amp;</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_QUEUE_GRAPHICS_BIT</span><span class="p">:</span>
                <span class="n">graphic_index</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">if</span> <span class="n">present_available</span><span class="p">:</span>
                <span class="n">present_index</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">if</span> <span class="n">graphic_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">present_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">graphic_index</span><span class="p">,</span> <span class="n">present_index</span>

    <span class="k">def</span> <span class="nf">_get_pfn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get extension function pointers</span>

<span class="sd">        Get only functions used in `VulkContext`, vulkan instance must exist</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `configuration`: Configuration from Application</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;_create_instance must be called before _get_pfn&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">VulkError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">add_pfn</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkGetInstanceProcAddr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t get address of </span><span class="si">%s</span><span class="s2"> extension function&quot;</span> <span class="o">%</span> <span class="n">name</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">VulkError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">extension_functions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;vkDestroySurfaceKHR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vkGetPhysicalDeviceSurfaceSupportKHR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vkGetPhysicalDeviceSurfaceCapabilitiesKHR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vkGetPhysicalDeviceSurfaceFormatsKHR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vkGetPhysicalDeviceSurfacePresentModesKHR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vkCreateSwapchainKHR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vkGetSwapchainImagesKHR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vkAcquireNextImageKHR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vkQueuePresentKHR&#39;</span>
        <span class="p">}</span>

        <span class="n">debug_extension_functions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;vkCreateDebugReportCallbackEXT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vkDestroyDebugReportCallbackEXT&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span><span class="p">:</span>
            <span class="n">extension_functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">debug_extension_functions</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">extension_functions</span><span class="p">:</span>
            <span class="n">add_pfn</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create Vulkan instance</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `window`: The window for Vulkan</span>
<span class="sd">        - `configuration`: Configuration from Application</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">extensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_instance_extensions</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_layers</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">extra_vulkan_layers</span><span class="p">:</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">extra_vulkan_layers</span><span class="p">)</span>

        <span class="n">app_info</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkApplicationInfo</span><span class="p">(</span>
            <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_APPLICATION_INFO</span><span class="p">,</span>
            <span class="n">pApplicationName</span><span class="o">=</span><span class="n">configuration</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">applicationVersion</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_MAKE_VERSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">pEngineName</span><span class="o">=</span><span class="n">ENGINE_NAME</span><span class="p">,</span>
            <span class="n">engineVersion</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_MAKE_VERSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">apiVersion</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_API_VERSION_1_0</span><span class="p">)</span>

        <span class="n">instance_create_info</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkInstanceCreateInfo</span><span class="p">(</span>
            <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">pApplicationInfo</span><span class="o">=</span><span class="n">app_info</span><span class="p">,</span>
            <span class="n">enabledExtensionCount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">extensions</span><span class="p">),</span>
            <span class="n">ppEnabledExtensionNames</span><span class="o">=</span><span class="n">extensions</span><span class="p">,</span>
            <span class="n">enabledLayerCount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span>
            <span class="n">ppEnabledLayerNames</span><span class="o">=</span><span class="n">layers</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkCreateInstance</span><span class="p">(</span><span class="n">pCreateInfo</span><span class="o">=</span><span class="n">instance_create_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_debug_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create debug callback</span>

<span class="sd">        It works only on debug mode</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `configuration`: Configuration from Application</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">vulkan_debug_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">vk</span><span class="o">.</span><span class="n">VK_DEBUG_REPORT_DEBUG_BIT_EXT</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="n">vk</span><span class="o">.</span><span class="n">VK_DEBUG_REPORT_WARNING_BIT_EXT</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
            <span class="n">vk</span><span class="o">.</span><span class="n">VK_DEBUG_REPORT_ERROR_BIT_EXT</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">vk</span><span class="o">.</span><span class="n">VK_DEBUG_REPORT_INFORMATION_BIT_EXT</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="n">vk</span><span class="o">.</span><span class="n">VK_DEBUG_REPORT_PERFORMANCE_WARNING_BIT_EXT</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">debug_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vulkan_debug_mapping</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;VULKAN: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_DEBUG_REPORT_ERROR_BIT_EXT</span> <span class="o">|</span>
                 <span class="n">vk</span><span class="o">.</span><span class="n">VK_DEBUG_REPORT_WARNING_BIT_EXT</span> <span class="o">|</span>
                 <span class="c1"># vk.VK_DEBUG_REPORT_INFORMATION_BIT_EXT |</span>
                 <span class="c1"># vk.VK_DEBUG_REPORT_DEBUG_BIT_EXT |</span>
                 <span class="n">vk</span><span class="o">.</span><span class="n">VK_DEBUG_REPORT_PERFORMANCE_WARNING_BIT_EXT</span><span class="p">)</span>

        <span class="n">debug_create_info</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkDebugReportCallbackCreateInfoEXT</span><span class="p">(</span>
            <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_DEBUG_REPORT_CALLBACK_CREATE_INFO_EXT</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span>
            <span class="n">pfnCallback</span><span class="o">=</span><span class="n">debug_function</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkCreateDebugReportCallbackEXT&#39;</span><span class="p">](</span>
            <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">pCreateInfo</span><span class="o">=</span><span class="n">debug_create_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_surface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create Vulkan surface</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `info`: The window information for Vulkan</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">call_platform</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">surface_create</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkGetInstanceProcAddr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">pCreateInfo</span><span class="o">=</span><span class="n">surface_create</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">xlib</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create XLIB surface&quot;</span><span class="p">)</span>
            <span class="c1"># pylint: disable=no-member</span>
            <span class="n">surface_create</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkXlibSurfaceCreateInfoKHR</span><span class="p">(</span>
                <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_XLIB_SURFACE_CREATE_INFO_KHR</span><span class="p">,</span>
                <span class="n">dpy</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">x11</span><span class="o">.</span><span class="n">display</span><span class="p">,</span>
                <span class="n">window</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">x11</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">call_platform</span><span class="p">(</span><span class="s1">&#39;vkCreateXlibSurfaceKHR&#39;</span><span class="p">,</span> <span class="n">surface_create</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">mir</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create MIR surface&quot;</span><span class="p">)</span>
            <span class="c1"># pylint: disable=no-member</span>
            <span class="n">surface_create</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkMirSurfaceCreateInfoKHR</span><span class="p">(</span>
                <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_MIR_SURFACE_CREATE_INFO_KHR</span><span class="p">,</span>
                <span class="n">connection</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">mir</span><span class="o">.</span><span class="n">connection</span><span class="p">,</span>
                <span class="n">mirSurface</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">mir</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">call_platform</span><span class="p">(</span><span class="s1">&#39;vkCreateMirSurfaceKHR&#39;</span><span class="p">,</span> <span class="n">surface_create</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">wayland</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create WAYLAND surface&quot;</span><span class="p">)</span>
            <span class="c1"># pylint: disable=no-member</span>
            <span class="n">surface_create</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkWaylandSurfaceCreateInfoKHR</span><span class="p">(</span>
                <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_WAYLAND_SURFACE_CREATE_INFO_KHR</span><span class="p">,</span>
                <span class="n">display</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">wl</span><span class="o">.</span><span class="n">display</span><span class="p">,</span>
                <span class="n">surface</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">call_platform</span><span class="p">(</span><span class="s1">&#39;vkCreateWaylandSurfaceKHR&#39;</span><span class="p">,</span> <span class="n">surface_create</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">windows</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Create WINDOWS surface&quot;</span><span class="p">)</span>
            <span class="c1"># pylint: disable=no-member</span>
            <span class="n">surface_create</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkWin32SurfaceCreateInfoKHR</span><span class="p">(</span>
                <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_WAYLAND_SURFACE_CREATE_INFO_KHR</span><span class="p">,</span>
                <span class="n">hinstance</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">hinstance</span><span class="p">,</span>
                <span class="n">hwdn</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">win</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">call_platform</span><span class="p">(</span><span class="s1">&#39;vkCreateWin32SurfaceKHR&#39;</span><span class="p">,</span> <span class="n">surface_create</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">android</span><span class="p">():</span>
            <span class="c1"># TODO</span>
            <span class="k">raise</span> <span class="n">VulkError</span><span class="p">(</span><span class="s2">&quot;Android not supported for now&quot;</span><span class="p">)</span>

        <span class="n">surface_mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SYSWM_X11</span><span class="p">:</span> <span class="n">xlib</span><span class="p">,</span>
            <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SYSWM_MIR</span><span class="p">:</span> <span class="n">mir</span><span class="p">,</span>
            <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SYSWM_WAYLAND</span><span class="p">:</span> <span class="n">wayland</span><span class="p">,</span>
            <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SYSWM_WINDOWS</span><span class="p">:</span> <span class="n">windows</span><span class="p">,</span>
            <span class="n">sdl2</span><span class="o">.</span><span class="n">SDL_SYSWM_ANDROID</span><span class="p">:</span> <span class="n">android</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">surface</span> <span class="o">=</span> <span class="n">surface_mapping</span><span class="p">[</span><span class="n">info</span><span class="o">.</span><span class="n">subsystem</span><span class="p">]()</span>

    <span class="k">def</span> <span class="nf">_create_physical_device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create Vulkan physical device</span>

<span class="sd">        The best physical device is selected through criteria.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">physical_devices</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkEnumeratePhysicalDevices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">physical_devices</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No physical device found&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">VulkError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">vk</span><span class="o">.</span><span class="n">vkGetPhysicalDeviceFeatures</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">physical_devices</span><span class="p">]</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">[</span><span class="n">vk</span><span class="o">.</span><span class="n">vkGetPhysicalDeviceProperties</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">physical_devices</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Available physical devices: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">deviceName</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">])</span>

        <span class="c1"># Select best physical device based on properties ans features</span>
        <span class="n">selected_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">physical_devices</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Discrete GPU is better</span>
            <span class="k">if</span> <span class="n">properties</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">deviceType</span> <span class="o">==</span> \
               <span class="n">vk</span><span class="o">.</span><span class="n">VK_PHYSICAL_DEVICE_TYPE_DISCRETE_GPU</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="mi">1000</span>

            <span class="n">score</span> <span class="o">+=</span> <span class="n">properties</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">limits</span><span class="o">.</span><span class="n">maxImageDimension2D</span>

            <span class="c1"># Device must contain graphic and present queue family</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">VulkContext</span><span class="o">.</span><span class="n">_get_queue_families</span><span class="p">(</span>
                <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkGetPhysicalDeviceSurfaceSupportKHR&#39;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">selected_index</span> <span class="o">=</span> <span class="n">i</span>

        <span class="c1"># No available physical device</span>
        <span class="k">if</span> <span class="n">best_score</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No available physical device&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">VulkError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># The best device is now selected_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physical_device</span> <span class="o">=</span> <span class="n">physical_devices</span><span class="p">[</span><span class="n">selected_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physical_device_properties</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="n">selected_index</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physical_device_features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">selected_index</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> device selected&quot;</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">physical_device_properties</span><span class="o">.</span><span class="n">deviceName</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create Vulkan logical device</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `configuration`: Configuration from Application</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="n">VulkContext</span><span class="o">.</span><span class="n">_get_device_extensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_device</span><span class="p">)</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_layers</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">configuration</span><span class="o">.</span><span class="n">extra_vulkan_layers</span><span class="p">:</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">extra_vulkan_layers</span><span class="p">)</span>

        <span class="n">graphic_index</span><span class="p">,</span> <span class="n">present_index</span> <span class="o">=</span> <span class="n">VulkContext</span><span class="o">.</span><span class="n">_get_queue_families</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">physical_device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkGetPhysicalDeviceSurfaceSupportKHR&#39;</span><span class="p">])</span>

        <span class="n">queues_create</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">vk</span><span class="o">.</span><span class="n">VkDeviceQueueCreateInfo</span><span class="p">(</span>
                <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_DEVICE_QUEUE_CREATE_INFO</span><span class="p">,</span>
                <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">queueFamilyIndex</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                <span class="n">queueCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">pQueuePriorities</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">{</span><span class="n">graphic_index</span><span class="p">,</span> <span class="n">present_index</span><span class="p">}]</span>

        <span class="n">device_create</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkDeviceCreateInfo</span><span class="p">(</span>
            <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_DEVICE_CREATE_INFO</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">queueCreateInfoCount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">queues_create</span><span class="p">),</span>
            <span class="n">pQueueCreateInfos</span><span class="o">=</span><span class="n">queues_create</span><span class="p">,</span>
            <span class="n">enabledLayerCount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span>
            <span class="n">ppEnabledLayerNames</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
            <span class="n">enabledExtensionCount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">extensions</span><span class="p">),</span>
            <span class="n">ppEnabledExtensionNames</span><span class="o">=</span><span class="n">extensions</span><span class="p">,</span>
            <span class="n">pEnabledFeatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_device_features</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkCreateDevice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_device</span><span class="p">,</span> <span class="n">device_create</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphic_queue</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkGetDeviceQueue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">graphic_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">present_queue</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">vkGetDeviceQueue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">present_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_family_indices</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;graphic&#39;</span><span class="p">:</span> <span class="n">graphic_index</span><span class="p">,</span>
                                     <span class="s1">&#39;present&#39;</span><span class="p">:</span> <span class="n">present_index</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_create_swapchain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create Vulkan swapchain</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `configuration`: Configuration from Application</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">surface_capabilities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkGetPhysicalDeviceSurfaceCapabilitiesKHR&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">)</span> <span class="c1"># noqa</span>
        <span class="n">surface_formats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkGetPhysicalDeviceSurfaceFormatsKHR&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">)</span> <span class="c1"># noqa</span>
        <span class="n">surface_present_modes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkGetPhysicalDeviceSurfacePresentModesKHR&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">)</span> <span class="c1"># noqa</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">surface_formats</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">surface_present_modes</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No available swapchain&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">VulkError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_format</span><span class="p">(</span><span class="n">formats</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_FORMAT_UNDEFINED</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">f</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_FORMAT_B8G8R8A8_UNORM</span> <span class="ow">and</span> \
                   <span class="n">f</span><span class="o">.</span><span class="n">colorSpace</span> <span class="o">==</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_COLOR_SPACE_SRGB_NONLINEAR_KHR</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">f</span>
            <span class="k">return</span> <span class="n">formats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">get_present_mode</span><span class="p">(</span><span class="n">present_modes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">present_modes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_PRESENT_MODE_MAILBOX_KHR</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">p</span>
            <span class="k">return</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_PRESENT_MODE_FIFO_KHR</span>

        <span class="k">def</span> <span class="nf">get_swap_extent</span><span class="p">(</span><span class="n">capabilities</span><span class="p">):</span>
            <span class="n">uint32_max</span> <span class="o">=</span> <span class="mi">4294967295</span>

            <span class="k">if</span> <span class="n">capabilities</span><span class="o">.</span><span class="n">currentExtent</span><span class="o">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">uint32_max</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">capabilities</span><span class="o">.</span><span class="n">currentExtent</span>

            <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">capabilities</span><span class="o">.</span><span class="n">minImageExtent</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">capabilities</span><span class="o">.</span><span class="n">maxImageExtent</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">configuration</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

            <span class="n">height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">capabilities</span><span class="o">.</span><span class="n">minImageExtent</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">capabilities</span><span class="o">.</span><span class="n">maxImageExtent</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">configuration</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkExtent2D</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>

        <span class="n">surface_format</span> <span class="o">=</span> <span class="n">get_format</span><span class="p">(</span><span class="n">surface_formats</span><span class="p">)</span>
        <span class="n">present_mode</span> <span class="o">=</span> <span class="n">get_present_mode</span><span class="p">(</span><span class="n">surface_present_modes</span><span class="p">)</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">get_swap_extent</span><span class="p">(</span><span class="n">surface_capabilities</span><span class="p">)</span>

        <span class="c1"># Try to create triple buffering</span>
        <span class="n">image_count</span> <span class="o">=</span> <span class="n">surface_capabilities</span><span class="o">.</span><span class="n">minImageCount</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">surface_capabilities</span><span class="o">.</span><span class="n">maxImageCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> \
           <span class="n">image_count</span> <span class="o">&gt;</span> <span class="n">surface_capabilities</span><span class="o">.</span><span class="n">maxImageCount</span><span class="p">:</span>
            <span class="n">image_count</span> <span class="o">=</span> <span class="n">surface_capabilities</span><span class="o">.</span><span class="n">maxImageCount</span>

        <span class="n">sharing_mode</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_SHARING_MODE_EXCLUSIVE</span>
        <span class="n">queue_family_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_family_indices</span><span class="p">[</span><span class="s1">&#39;graphic&#39;</span><span class="p">]</span> <span class="o">!=</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">queue_family_indices</span><span class="p">[</span><span class="s1">&#39;present&#39;</span><span class="p">]:</span>
            <span class="n">sharing_mode</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VK_SHARING_MODE_CONCURRENT</span>
            <span class="n">queue_family_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">queue_family_indices</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="c1"># Finally create swapchain</span>
        <span class="n">swapchain_create</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkSwapchainCreateInfoKHR</span><span class="p">(</span>
            <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_SWAPCHAIN_CREATE_INFO_KHR</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">surface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">surface</span><span class="p">,</span>
            <span class="n">minImageCount</span><span class="o">=</span><span class="n">image_count</span><span class="p">,</span>
            <span class="n">imageFormat</span><span class="o">=</span><span class="n">surface_format</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
            <span class="n">imageColorSpace</span><span class="o">=</span><span class="n">surface_format</span><span class="o">.</span><span class="n">colorSpace</span><span class="p">,</span>
            <span class="n">imageExtent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="n">imageArrayLayers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">imageUsage</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_IMAGE_USAGE_TRANSFER_DST_BIT</span><span class="p">,</span>
            <span class="n">imageSharingMode</span><span class="o">=</span><span class="n">sharing_mode</span><span class="p">,</span>
            <span class="n">queueFamilyIndexCount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">queue_family_indices</span><span class="p">),</span>
            <span class="n">pQueueFamilyIndices</span><span class="o">=</span><span class="n">queue_family_indices</span><span class="p">,</span>
            <span class="n">compositeAlpha</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_COMPOSITE_ALPHA_OPAQUE_BIT_KHR</span><span class="p">,</span>
            <span class="n">presentMode</span><span class="o">=</span><span class="n">present_mode</span><span class="p">,</span>
            <span class="n">clipped</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_TRUE</span><span class="p">,</span>
            <span class="n">oldSwapchain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">preTransform</span><span class="o">=</span><span class="n">surface_capabilities</span><span class="o">.</span><span class="n">currentTransform</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">swapchain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkCreateSwapchainKHR&#39;</span><span class="p">](</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">swapchain_create</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">extent</span><span class="o">.</span><span class="n">height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swapchain_format</span> <span class="o">=</span> <span class="n">surface_format</span><span class="o">.</span><span class="n">format</span>

        <span class="n">swapchain_raw_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkGetSwapchainImagesKHR&#39;</span><span class="p">](</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swapchain</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">swapchain_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">raw_image</span> <span class="ow">in</span> <span class="n">swapchain_raw_images</span><span class="p">:</span>
            <span class="c1"># Put swapchain image in Image</span>
            <span class="c1"># It&#39;s a bad practice but for this specific use case, it&#39;s good</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">vo</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">raw_image</span>
            <span class="n">img</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">surface_format</span><span class="o">.</span><span class="n">format</span>
            <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
            <span class="n">img</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
            <span class="n">img</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">swapchain_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="c1"># Update layout of all swapchain images to present khr</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">swapchain_images</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">vo</span><span class="o">.</span><span class="n">immediate_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="n">image</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">UNDEFINED</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">PRESENT_SRC_KHR</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">MEMORY_READ</span>
                <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Swapchain created with </span><span class="si">%s</span><span class="s2"> images&quot;</span><span class="p">,</span>
                     <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swapchain_images</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_create_final_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">usage</span> <span class="o">=</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageUsage</span><span class="o">.</span><span class="n">TRANSFER_SRC</span> <span class="o">|</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageUsage</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT</span> <span class="o">|</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageUsage</span><span class="o">.</span><span class="n">TRANSFER_DST</span>  <span class="c1"># noqa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageType</span><span class="o">.</span><span class="n">TYPE_2D</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swapchain_format</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">SampleCount</span><span class="o">.</span><span class="n">COUNT_1</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">SharingMode</span><span class="o">.</span><span class="n">EXCLUSIVE</span><span class="p">,</span> <span class="p">[],</span>
            <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">UNDEFINED</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageTiling</span><span class="o">.</span><span class="n">OPTIMAL</span><span class="p">,</span> <span class="n">usage</span><span class="p">,</span>
            <span class="n">vc</span><span class="o">.</span><span class="n">MemoryProperty</span><span class="o">.</span><span class="n">DEVICE_LOCAL</span>
        <span class="p">)</span>

        <span class="c1"># Fill image memory and put it into color attachment layout</span>
        <span class="n">clear_color</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">ClearColorValue</span><span class="p">(</span><span class="n">float32</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">vo</span><span class="o">.</span><span class="n">ImageSubresourceRange</span><span class="p">(</span><span class="n">vc</span><span class="o">.</span><span class="n">ImageAspect</span><span class="o">.</span><span class="n">COLOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">with</span> <span class="n">vo</span><span class="o">.</span><span class="n">immediate_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">UNDEFINED</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_DST_OPTIMAL</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">TRANSFER_WRITE</span>
            <span class="p">)</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">clear_color_image</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_DST_OPTIMAL</span><span class="p">,</span>
                <span class="n">clear_color</span><span class="p">,</span> <span class="n">ranges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_DST_OPTIMAL</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_OPTIMAL</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">BOTTOM_OF_PIPE</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">BOTTOM_OF_PIPE</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_WRITE</span>
            <span class="p">)</span>

        <span class="c1"># Create image view</span>
        <span class="n">subresource_range</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">ImageSubresourceRange</span><span class="p">(</span>
            <span class="n">aspect</span><span class="o">=</span><span class="n">vc</span><span class="o">.</span><span class="n">ImageAspect</span><span class="o">.</span><span class="n">COLOR</span><span class="p">,</span>
            <span class="n">base_miplevel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">level_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">base_layer</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">layer_count</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">final_image_view</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">ImageView</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageViewType</span><span class="o">.</span><span class="n">TYPE_2D</span><span class="p">,</span>
            <span class="n">vc</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swapchain_format</span><span class="p">),</span> <span class="n">subresource_range</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_commandbuffers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create the command buffers used to copy image&#39;&#39;&#39;</span>
        <span class="n">commandpool</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">CommandPool</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_family_indices</span><span class="p">[</span><span class="s1">&#39;graphic&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandbuffers</span> <span class="o">=</span> <span class="n">commandpool</span><span class="o">.</span><span class="n">allocate_buffers</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">CommandBufferLevel</span><span class="o">.</span><span class="n">PRIMARY</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">swapchain_images</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">commandbuffer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commandbuffers</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">commandbuffer</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span> <span class="k">as</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_OPTIMAL</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_SRC_OPTIMAL</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_WRITE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">TRANSFER_READ</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">swapchain_images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">PRESENT_SRC_KHR</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_DST_OPTIMAL</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">MEMORY_READ</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">TRANSFER_WRITE</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swapchain_images</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">swapchain_images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_DST_OPTIMAL</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">PRESENT_SRC_KHR</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">BOTTOM_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">BOTTOM_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">TRANSFER_WRITE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">MEMORY_READ</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_SRC_OPTIMAL</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_OPTIMAL</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">BOTTOM_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">BOTTOM_OF_PIPE</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">TRANSFER_READ</span><span class="p">,</span>
                    <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_WRITE</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_semaphores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create semaphores used during image swaping&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_semaphore_available</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_semaphore_copied</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_direct_semaphores</span> <span class="o">=</span> <span class="p">[</span><span class="n">vo</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">vo</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>

<div class="viewcode-block" id="VulkContext.create"><a class="viewcode-back" href="../../vulk.html#vulk.context.VulkContext.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create Vulkan context</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `window`: The `VulkWindow`</span>
<span class="sd">        - `configuration`: Configuration from Application</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_enabled</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_instance</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>

        <span class="c1"># Next functions need extension pointers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_pfn</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_debug_callback</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_surface</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_physical_device</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_device</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_swapchain</span><span class="p">(</span><span class="n">configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_final_image</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_commandbuffers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_semaphores</span><span class="p">()</span></div>

<div class="viewcode-block" id="VulkContext.clear_final_image"><a class="viewcode-back" href="../../vulk.html#vulk.context.VulkContext.clear_final_image">[docs]</a>    <span class="k">def</span> <span class="nf">clear_final_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Clear the final image with `colors`</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `colors`: `list` of 4 `float` (rgba)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">clear_color</span> <span class="o">=</span> <span class="n">vo</span><span class="o">.</span><span class="n">ClearColorValue</span><span class="p">(</span><span class="n">float32</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">vo</span><span class="o">.</span><span class="n">ImageSubresourceRange</span><span class="p">(</span><span class="n">vc</span><span class="o">.</span><span class="n">ImageAspect</span><span class="o">.</span><span class="n">COLOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">with</span> <span class="n">vo</span><span class="o">.</span><span class="n">immediate_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">cmd</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_OPTIMAL</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_DST_OPTIMAL</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">TOP_OF_PIPE</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_WRITE</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">TRANSFER_WRITE</span>
            <span class="p">)</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">clear_color_image</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_DST_OPTIMAL</span><span class="p">,</span>
                <span class="n">clear_color</span><span class="p">,</span> <span class="n">ranges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_image</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">TRANSFER_DST_OPTIMAL</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">ImageLayout</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_OPTIMAL</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">BOTTOM_OF_PIPE</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">BOTTOM_OF_PIPE</span><span class="p">,</span>
                <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">TRANSFER_WRITE</span><span class="p">,</span> <span class="n">vc</span><span class="o">.</span><span class="n">Access</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_WRITE</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="VulkContext.swap"><a class="viewcode-back" href="../../vulk.html#vulk.context.VulkContext.swap">[docs]</a>    <span class="k">def</span> <span class="nf">swap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">semaphores</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Display final image on screen.</span>

<span class="sd">        This function makes all the rendering work. To proceed, it copies the</span>
<span class="sd">        `final_image` into the current swapchain image previously acquired.</span>
<span class="sd">        You can pass custom semaphores (and you should) to synchronize the</span>
<span class="sd">        command.</span>

<span class="sd">        *Parameters:*</span>

<span class="sd">        - `semaphore`: A `list` of `Semaphore` to wait on</span>

<span class="sd">        **Note: `final_image` layout is handled by `VulkContext`. You must</span>
<span class="sd">                 let it to COLOR_ATTACHMENT_OPTIMAL**</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Acquire image</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkAcquireNextImageKHR&#39;</span><span class="p">](</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swapchain</span><span class="p">,</span> <span class="n">vk</span><span class="o">.</span><span class="n">UINT64_MAX</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_semaphore_available</span><span class="o">.</span><span class="n">semaphore</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">wait_semaphores</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_semaphore_available</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">semaphores</span><span class="p">:</span>
            <span class="n">wait_semaphores</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">semaphores</span><span class="p">)</span>

        <span class="n">wait_masks</span> <span class="o">=</span> <span class="p">[</span><span class="n">vc</span><span class="o">.</span><span class="n">PipelineStage</span><span class="o">.</span><span class="n">COLOR_ATTACHMENT_OUTPUT</span><span class="p">]</span>
        <span class="n">wait_masks</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wait_semaphores</span><span class="p">)</span>

        <span class="n">copied_semaphores</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_semaphore_copied</span><span class="o">.</span><span class="n">semaphore</span><span class="p">]</span>

        <span class="c1"># Transfer final image to swapchain image</span>
        <span class="n">submit</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkSubmitInfo</span><span class="p">(</span>
            <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_SUBMIT_INFO</span><span class="p">,</span>
            <span class="n">waitSemaphoreCount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">wait_semaphores</span><span class="p">),</span>
            <span class="n">pWaitSemaphores</span><span class="o">=</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">semaphore</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wait_semaphores</span><span class="p">],</span>
            <span class="n">pWaitDstStageMask</span><span class="o">=</span><span class="n">wait_masks</span><span class="p">,</span>
            <span class="n">commandBufferCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">pCommandBuffers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">commandbuffers</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">commandbuffer</span><span class="p">],</span>
            <span class="n">signalSemaphoreCount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">copied_semaphores</span><span class="p">),</span>
            <span class="n">pSignalSemaphores</span><span class="o">=</span><span class="n">copied_semaphores</span>
        <span class="p">)</span>
        <span class="n">vk</span><span class="o">.</span><span class="n">vkQueueSubmit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphic_queue</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">submit</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Present swapchain image on screen</span>
        <span class="n">present</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">VkPresentInfoKHR</span><span class="p">(</span>
            <span class="n">sType</span><span class="o">=</span><span class="n">vk</span><span class="o">.</span><span class="n">VK_STRUCTURE_TYPE_PRESENT_INFO_KHR</span><span class="p">,</span>
            <span class="n">waitSemaphoreCount</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">copied_semaphores</span><span class="p">),</span>
            <span class="n">pWaitSemaphores</span><span class="o">=</span><span class="n">copied_semaphores</span><span class="p">,</span>
            <span class="n">swapchainCount</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">pSwapchains</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">swapchain</span><span class="p">],</span>
            <span class="n">pImageIndices</span><span class="o">=</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
            <span class="n">pResults</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">[</span><span class="s1">&#39;vkQueuePresentKHR&#39;</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">present_queue</span><span class="p">,</span> <span class="n">present</span><span class="p">)</span>

        <span class="n">vk</span><span class="o">.</span><span class="n">vkDeviceWaitIdle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span></div>

<div class="viewcode-block" id="VulkContext.get_events"><a class="viewcode-back" href="../../vulk.html#vulk.context.VulkContext.get_events">[docs]</a>    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sdl_event</span> <span class="ow">in</span> <span class="n">sdl2</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">get_events</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">to_vulk_event</span><span class="p">(</span><span class="n">sdl_event</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Vulk Engine.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>